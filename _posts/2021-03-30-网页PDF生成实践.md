---
layout: post
title: "ç½‘é¡µ PDF ç”Ÿæˆå®è·µ"
date: 2021-03-30
excerpt: "from html to pdf"
tags: [å°ç¨‹åº]
comments: false
---

## èƒŒæ™¯

åœ¨ä¸€äº›æ•°æ®æŠ¥è¡¨ç±»å‹çš„é¡¹ç›®ä¸­ï¼Œç”¨æˆ·ä¸€èˆ¬ä¼šå¸Œæœ›èƒ½å¤Ÿå°†æ•°æ®ä¿å­˜ä¸‹æ¥ã€‚é™¤äº†å¸¸è§„çš„ä¸‹è½½ excel æ–‡ä»¶ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥å°è¯•ç”Ÿæˆ PDF æ–‡ä»¶ã€‚ç›¸æ¯”äº excelï¼ŒPDF æœ€å¤§çš„ä¼˜ç‚¹æ˜¯èƒ½å¤Ÿé™„å¸¦å¤æ‚çš„æ ·å¼ï¼Œè€Œä¸”æ–¹ä¾¿ç”¨æˆ·æ‰“å°ã€‚

## å‰ç«¯ï¼Ÿåç«¯ï¼Ÿ

åœ¨é¡¹ç›®ä¸­ Excel ç”Ÿæˆä¸€èˆ¬ç”±åç«¯æ‰¿æ‹…ï¼Œå› ä¸ºæœ‰è®¸å¤šå¾ˆæ–¹ä¾¿çš„ SQL ç»“æœç›´æ¥å¯¼å‡ºç”Ÿæˆ Excel æ–‡ä»¶çš„å·¥å…·åº“ï¼Œå¼€å‘æˆæœ¬æ¯”è¾ƒä½ã€‚é‚£ä¹ˆ PDF å‘¢ï¼Ÿ

åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œé€‰æ‹©äº†**å‰ç«¯ç”Ÿæˆ**çš„æ–¹æ¡ˆï¼Œwhyï¼Ÿ
- PDF å¸¦æœ‰å¤§é‡çš„æ’ç‰ˆæ ·å¼ï¼Œå±äºå‰ç«¯çš„å…³æ³¨ç‚¹
- ç›¸è¾ƒäºåœ¨åç«¯å‘½ä»¤å¼çš„ç»˜åˆ¶ï¼ŒåŸºäºå‰ç«¯ç½‘é¡µæ ·å¼â€œæ‰“å°â€ PDF å¼€å‘æˆæœ¬æ›´ä½

## æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”

### æµè§ˆå™¨æ‰“å°

è¿™æ˜¯èƒ½å¤Ÿç›´æ¥æƒ³åˆ°çš„æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯æœ€ç¬¦åˆæµè§ˆå™¨æ ‡å‡†çš„ã€‚ç®€å•æè¿°æ­¥éª¤ä¸º: è°ƒç”¨æµè§ˆå™¨æ‰“å°æœºï¼Œé€‰æ‹© PDF æ‰“å°æœºï¼Œå°†é¡µé¢æ‰“å°ä¿å­˜å³å¯ã€‚

å¯¹äº PDF æ ·å¼ï¼Œå¯ä»¥ä½¿ç”¨åª’ä½“æŸ¥è¯¢è°ƒæ•´ï¼Œä¾‹å¦‚ï¼š
```css
@media print {
  body { font-size: 10pt; }
}

```

æµè§ˆå™¨æ‰“å°çš„æ–¹æ¡ˆçœ‹èµ·æ¥å¾ˆç†æƒ³ï¼Œå®é™…å¾ˆéš¾ç”¨ã€‚æœ€éº»çƒ¦çš„æ˜¯ï¼Œæ²¡æœ‰æµè§ˆå™¨æ¥å£æ¥é…ç½®æ‰“å°æœºã€‚åœ¨æ ‡å‡†ä¸­ï¼Œè°ƒç”¨æµè§ˆå™¨æ‰“å°å°±ä¸€ä¸ªæ–¹æ³•:

```js
window.print()
```

å¯¹ï¼Œåœ¨[w3cæ ‡å‡†](https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#printing)ä¸­è¿™ä¸ªæ–¹æ³•å°±æ²¡æœ‰ä»»ä½•é…ç½®é¡¹ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä¼šç›´æ¥è°ƒç”¨æµè§ˆå™¨çš„æ‰“å°å¯¹è¯æ¡†ã€‚

![image.png](../assets/img/mdimg/2021-03-30-ç½‘é¡µPDFç”Ÿæˆå®è·µ/sWQJ6pCKokb43x2y-5854688.png)

è¿™å°±éœ€è¦ç”¨æˆ·æ‰‹åŠ¨é…ç½®æ‰“å°æœºï¼Œä½“éªŒæ¯”è¾ƒå·®ã€‚è€Œä¸”ä¸åŒçš„æµè§ˆå™¨å®ç°çš„æ‰“å°å¯¹è¯æ¡†å¯èƒ½è¿˜ä¸ç›¸åŒï¼Œè¿™å°±å¾ˆéš¾æäº†ã€‚å¦‚æœå¯¹äº PDF æ ·å¼è¦æ±‚æ¯”è¾ƒä½ï¼Œå¯ä»¥é‡‡ç”¨è¿™ç§æ–¹æ¡ˆã€‚

> å¾ˆå¤šæµè§ˆå™¨å‚å•†ä¹Ÿåœ¨æ¨è¿›æ›´å¥½çš„æ‰“å°ä½“éªŒï¼Œæ¯”å¦‚ firefox å’Œ chrome éƒ½æ¨å‡ºäº† [silent print](https://bugs.chromium.org/p/chromium/issues/detail?id=31395#c4) åŠŸèƒ½ï¼Œä¸è¿‡ç›®å‰å±äºéœ€è¦ç”¨æˆ·æ‰‹åŠ¨é…ç½®å¼€å¯çš„å®éªŒåŠŸèƒ½ï¼Œæ²¡æ³•åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚å¯ä»¥æœŸå¾…ä»Šåçš„å‘å±•ã€‚


### ä½¿ç”¨ PDF å¼€æºåº“

ç›¸æ¯”äºä¸å¯æ§çš„æµè§ˆå™¨æ‰“å°ï¼Œæ‰‹åŠ¨æ§åˆ¶ PDF ç”Ÿæˆå¯ä»¥è¾¾åˆ°å¯¹æ ·å¼æ›´ç²¾å‡†æ§åˆ¶ã€‚ä¹Ÿå¯ä»¥åšåˆ°é™é»˜ç”Ÿæˆï¼Œä¸ä¼šåƒæµè§ˆå™¨æ‰“å°ä¸€æ ·å¼¹å‡ºæ‰“å°å¯¹è¯æ¡†ã€‚

æœ‰å¾ˆå¤š JavaScript å¼€æºåº“å¯ä»¥ç”¨æ¥æ“ä½œ PDFï¼Œå…¶ä¸­æ¯”è¾ƒçƒ­é—¨çš„ä¸€ä¸ªæ˜¯ [JsPDF](https://artskydj.github.io/jsPDF/docs/index.html)ï¼Œåœ¨ Github ä¸Šæ‹¥æœ‰ 20k startsï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä¸­å°±é‡‡ç”¨äº†ä»–ã€‚ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç±»ä¼¼ Canvas çš„å‘½ä»¤å¼ç»˜åˆ¶:

```js
var doc = new jsPDF();

doc.text('Hello world!', 10, 10);
doc.line(0,0,10,0,'S');

doc.save('a4.pdf');
```

å¦å¤–è¿˜æœ‰ [html2pdf](https://github.com/spipu/html2pdf)è¿™ä¸ªåº“ï¼ŒåŸºäº JsPDF å¼€å‘ï¼Œæ®ä½œè€…æè¿°æ˜¯å¯ä»¥ç”¨æ¥ç›´æ¥å°†é¡µé¢è½¬åŒ–ä¸º pdf æ–‡ä»¶ã€‚ä½†åœ¨æœ¬æ–‡ç¼–å†™æ—¶å·²ç»æœ‰1å¹´æ²¡æœ‰æ›´æ–°ï¼Œissues ä¹Ÿéƒ½æ²¡æœ‰å›å¤ï¼Œçœ‹èµ·æ¥æ˜¯å¼ƒå‘äº†ã€‚

## ä»£ç å®ç°

é¦–å…ˆéœ€è¦ä»‹ç»å¦å¤–ä¸€ä¸ªå¼€æºåº“ [html2canvas](https://github.com/niklasvh/html2canvas)ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäº Canvas å®ç°çš„ html æ¸²æŸ“å™¨ã€‚

å®ç°æ€è·¯å¯ä»¥ç®€å•åœ°æè¿°ä¸º: html -> canvas -> image -> pdfï¼Œå…¶ä¸­æ¯ä¸€æ­¥:
- ä½¿ç”¨ html2canvas å°†é¡µé¢ HTML ç»“æ„ç»˜åˆ¶åˆ°ä¸€ä¸ª canvas ä¸Š
- [CanvasElement.toDataURL()](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLCanvasElement/toDataURL) å¯ä»¥å°† canvas å¯¼å‡ºä¸ºå›¾ç‰‡æ•°æ®
- ä½¿ç”¨ js2pdf å°†å›¾ç‰‡æ·»åŠ åˆ° PDF æ–‡ä»¶ä¸­ï¼Œå¹¶æŒ‰ä¸šåŠ¡è°ƒæ•´ PDF åˆ†é¡µ
- ä¿å­˜æ–‡ä»¶

å¤§ä½“æ€è·¯å°±æ˜¯è¿™æ ·ï¼Œå¦‚æœä½ è¿˜æœ‰æ—¶é—´ï¼Œæˆ‘ä»¬è¿˜æœ‰å¾ˆå¤šå®ç°ç»†èŠ‚ä¼˜åŒ–å¯ä»¥è°ˆè°ˆã€‚

### with React

é›†æˆåœ¨ React ç»„ä»¶ä¸­æ˜¯ä¸€ä¸ªå¸¸è§çš„éœ€æ±‚ã€‚æˆ‘ä»¬ä¸ºé¡µé¢æ ¹ç»„ä»¶æ·»åŠ ä¸€ä¸ªæ–°çš„ prop `onGeneratePDF` å’Œæ–°çš„å‰¯ä½œç”¨:

```jsx
const { onGeneratePDF } = props;

/**
* effect: åœ¨pdfæ¨¡å¼ä¸‹ä¸”é¡µé¢å·²ç»åŠ è½½å®Œæˆï¼Œæ„é€  canvas generator
*
* å…¶ä»– dependencies: 
* loadComplete é¡µé¢åŠ è½½çš„æ ‡å¿—state
* containerRef é¡µé¢æ ¹ç»„ä»¶çš„ ref
*/
React.useEffect(() => {
    if (loadComplete && onGeneratePDF && containerRef.current) {
      const canvasNode = html2canvas(containterRef.current)
	  onGeneratePDF(new JsPDF(canavsNode))
    }
}, [loadComplete, onGeneratePDF, containerRef]);
```

å½“ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æŒ‰é’®:

```jsx
const onClickDownload = async () => {
  const pdf = await new Promise((res) => {
  ReactDOM.render(
    /** é¡µé¢ç»„ä»¶ */
    <MyPage onGeneratePDF={res}></MyPage>,
    /** ä¸€ä¸ªéšè—èŠ‚ç‚¹ */
    rootDiv,
  );
		
  pdf.save('æ•°æ®æŠ¥å‘Š.pdf');
  });
}
```

è¿™é‡Œçš„ä»£ç ç»è¿‡äº†å¤§é‡ç®€åŒ–ï¼ŒçœŸå®å®ç°å¯ä»¥å‚è€ƒæ–‡ç« æœ«å°¾çš„é“¾æ¥ã€‚

### é¿å…è¿‡å¤§ Canvas ç»˜åˆ¶å¯¼è‡´å¡é¡¿

ç”±äº html2canvas ä¾èµ–æµè§ˆå™¨ canvas å®ç°ï¼Œå¦‚æœä¸€æ¬¡ç»˜åˆ¶å¤§é‡å†…å®¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´é¡µé¢å¸§æ•°çªç„¶é™ä½ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨å°†é¡µé¢çš„å­å…ƒç´ ä¸²è¡Œç»˜åˆ¶ï¼Œä¸€æ¬¡åªç”»ä¸€å°å—å†…å®¹ï¼Œæœ€åæ‹¼æ¥åˆ°ä¸€èµ·ã€‚

æˆ‘å†™äº†ä¸€ä¸ªå°çš„å®ç”¨ç±»æ¥åšè¿™ä»¶äº‹:
```typescript
export class CanvasGenerator {
  private elementsToPaint: HTMLElement[] = [];
  private currentPaint = 0;

  constructor(generateRoot: HTMLElement) {
    this.elementsToPaint = Array.from(generateRoot.children)
  }

  public *generateSlice() {
    while (this.elementsToPaint.length > this.currentPaint) {
      yield {
        canvasNode: html2canvas(this.elementsToPaint[this.currentPaint]),
        index: this.currentPaint,
        total: this.elementsToPaint.length,
      };
      this.currentPaint = this.currentPaint + 1;
    }
  }

  public getNumOfSlices() {
    return this.elementsToPaint.length;
  }
}

```

è¿™ä¸ªç±»æ¥å—é¡µé¢çš„æ ¹å…ƒç´ ï¼Œæ„é€ ä¸€ä¸ª generator å‡½æ•°ï¼Œè®©å¼€å‘è€…å¯ä»¥æ‰‹åŠ¨æ§åˆ¶ã€‚

ğŸŒ°
```js
// ä½¿ç”¨é¡µé¢è·Ÿç»„ä»¶æ„é€  generator
const generator = new CanavsGenerator(pageRoot).generateSlice();
const slices = [];

let slice = generator.next();

while (!slice.done) {
    const canvasNode = await slice.value.canvasNode;
    slices.push({
      width: canvasNode.width,
      height: canvasNode.height,
      datauri: canvasNode.toDataURL('image/png'),
    });

    slice = generator.next();
  }

console.log(slices) // ä¸€ä¸ªå›¾ç‰‡æ•°ç»„ï¼Œä¸‹æ–‡è¿˜æœ‰ç”¨
```

è¿™æ ·æ‰‹åŠ¨æ§åˆ¶ä¸²è¡Œç”Ÿæˆè¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼šèƒ½å¤Ÿè·å–å½“å‰ç»˜åˆ¶è¿›åº¦ä¿¡æ¯ã€‚æœ‰äº†è¿™ä¸ªä¿¡æ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”»ä¸€ä¸ªè¿›åº¦æ¡ï¼Œå…·ä½“ç»†èŠ‚åæ–‡è®¨è®ºã€‚

### with Webworker

å°† PDF ç”Ÿæˆçš„ä»»åŠ¡æ”¾è¿› Webworker ä¸­ï¼Œå¯ä»¥é¿å…æµè§ˆå™¨ä¸»çº¿ç¨‹é˜»å¡ã€‚

> å¦‚æœä¸äº†è§£ webworkerï¼Œå¯ä»¥å‚è€ƒ [MDN ä½¿ç”¨ WebWorker](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers)

> æˆ‘ä»¬ç”¨äº†[workerize-loader](https://github.com/developit/workerize-loader)è¿™ä¸ªwebpack loader æ¥ç®€åŒ– worker å¼€å‘ã€‚è¿™ä¸ªåº“éå¸¸èµï¼Œä½œè€…æ˜¯ preact çš„ä½œè€… developitï¼Œå¤§ç¥å‡ºå“ ğŸ‘

worker è¿›ç¨‹:

```js
// pdf.worker.js

/*
* @params slices ä¸Šä¸€å°ç»“ç”Ÿæˆçš„å›¾ç‰‡æ•°ç»„
*/
export function generatePDF(slices) {
  const pdf = new Jspdf('portrait', 'px');

  for (let index = 0; index < slices.length; index = index + 1) {
    const slice = slices[index];
    // å°†æ¯ä¸ªå­å…ƒç´ ä½œä¸º pdf çš„ä¸€é¡µå†…å®¹
    pdf.addPage([slice.width, slice.height]);
    pdf.addImage(slice.datauri, 'PNG', 0, 0, slice.width, slice.height);
  }

  // å°† pdf è½¬ä¸ºå­—ç¬¦ä¸²è¾“å‡ºï¼Œå› ä¸º worker å’Œä¸»çº¿ç¨‹ä¹‹é—´ä¼ é€’æ¶ˆæ¯ postMessage åªèƒ½æ¥å—å­—ç¬¦ä¸²
  return pdf.output('datauristring');
}

```
åœ¨é¡µé¢è¿›ç¨‹ä¸­ï¼Œæ„é€  worker å¹¶ç­‰å¾…å®Œæˆåä¸‹è½½ï¼š

```jsx
// page.tsx

import PDFWorker from 'workerize-loader!./pdf-utils/pdf.worker.js'; 

const dataUri = await PDFWorker().generatePDF(slices)
const a = document.createElement('a');
a.href = dataUri;
a.download = 'file_output.pdf';
a.click();
```

### æ¼‚äº®çš„è¿›åº¦æ¡

ä¸æ™®é€šçš„ä¸‹è½½ä¸åŒï¼Œè¿™æ ·å‰ç«¯ç”Ÿæˆ PDF å¯èƒ½ä¼šæ¶ˆè€—æ›´å¤šçš„æ—¶é—´åœ¨ç»˜åˆ¶ï¼Œå¹¶ä¸ä¼šç›´æ¥å°†æ–‡ä»¶åŠ å…¥æµè§ˆå™¨ä¸‹è½½åˆ—è¡¨ã€‚å¦‚æœæ—¶é—´è¿‡é•¿ï¼Œç”¨æˆ·å¯èƒ½ä¼šè§‰å¾—é¡µé¢æ²¡ååº”å¡ä½äº†ã€‚

åœ¨è¿™æ ·çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœæœ‰ä¸€ä¸ªè¿›åº¦æ¡ï¼ŒæŒ‡ç¤ºå½“å‰è¿›åº¦ï¼Œå¯ä»¥å¤§å¤§æå‡ç”¨æˆ·ä½“éªŒã€‚

å‰æ–‡æåˆ°ï¼Œåœ¨ Canvas ç»˜åˆ¶ä¸­ï¼Œæˆ‘ä»¬ç”¨äº†ä¸€ä¸ª Generator å‡½æ•°ï¼Œåœ¨å¾ªç¯ä¸­å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è·å–å½“å‰ç»˜åˆ¶è¿›åº¦:

```js
let paintIndex = 0;

/** ä¸€å…±éœ€è¦ç»˜åˆ¶çš„å…ƒç´ æ•°é‡ */
const totalElementToPaint = root.children.length;

while(!slice.done){
  await slice.canvas;
  paintIndex = paintIndex + 1;
  // è®¡ç®—å¾—åˆ°å½“å‰ç»˜åˆ¶è¿›åº¦
  console.log(paintIndex / totalElementToPaint);
  slice = generator.next()
}
```
åœ¨ç”Ÿæˆ PDF çš„ workerä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ postMessage æœºåˆ¶æ¥å‘ä¸»è¿›ç¨‹ä¼ é€’å½“å‰è¿›åº¦:
```js
// workder.js
for (let index = 0; index < slices.length; index = index + 1) {
    const slice = slices[index];
    pdf.addPage([slice.width, slice.height]);
    pdf.addImage(slice.datauri, 'PNG', 0, 0, slice.width, slice.height);
	
    self.postMessage({
      type: 'process-report',
      value: (index + 1) / slices.length,
    });
}
```

```tsx
// page.tsx
workder.addEventListener('message', msg => {
    if (msg.data.type !== 'process-report') {
      return;
    }
	
    // ä» worker ä¸­è·å¾—å½“å‰è¿›åº¦æ¶ˆæ¯
    console.log(msg.data.value);
})
```
è¿™æ ·è¿›åº¦ä¿¡æ¯å°±é½å…¨äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯è°ƒè°ƒåŠ¨ç”»ï¼Œç”»ä¸€ä¸ªå¥½çœ‹çš„è¿›åº¦æ¡ï¼Œè¿™é‡Œå°±æ˜¯ä¸ªäººå‘æŒ¥äº†ã€‚

![image.png](../assets/img/mdimg/2021-03-30-ç½‘é¡µPDFç”Ÿæˆå®è·µ/PdT5JsEndJJtLAeL.png)

### html2canvas ä¸­çš„å‘

> é¦–å…ˆæˆ‘å¿…é¡»è¯´ï¼Œè¿™ä¸ªé¡¹ç›®è¿˜æ˜¯éå¸¸å‰å®³çš„ï¼Œç›¸å½“äºä½œè€…ç”¨ canvas å®ç°äº†ä¸€ä¸ªæµè§ˆå™¨ç»˜åˆ¶å¼•æ“ï¼Œèƒ½å¤Ÿè§£æ html ç»“æ„ã€css æ ·å¼ç­‰ç­‰ã€‚ä½†æ˜¯å•†ä¸šå›¢é˜Ÿåšçš„æµè§ˆå™¨éƒ½å¯èƒ½æœ‰ bugï¼Œä½•å†µæ˜¯ä¸ªäººçš„å¼€æºé¡¹ç›®å‘¢ï¼Ÿ

- ä¸èƒ½åœ¨é¡µé¢æœªåŠ è½½å®Œæˆæ—¶ç”Ÿæˆ Canvas
	- åœ¨ React ç»„ä»¶ä¸­æ·»åŠ ä¸€äº› effect å’Œ hooks æ¥ç›‘æ§é¡µé¢åŠ è½½çŠ¶æ€
- å…³é—­åŠ¨ç”»
- é¿å…ä½¿ç”¨ä¸€äº› css hackï¼Œå¯èƒ½ html2canvas å¹¶ä¸èƒ½å®ç°
- æ³¨æ„æµè§ˆå™¨çš„å•ä¸ª canvas æ˜¯ç»˜åˆ¶åƒç´ æ•°é‡ä¸Šé™çš„
- åœ¨å¤šä¸ªæµè§ˆå™¨ä¸­æµ‹è¯•

## é™„